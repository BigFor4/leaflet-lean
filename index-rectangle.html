<!DOCTYPE html>
<html>

<head>
    <meta name="viewport" content="initial-scale=1,maximum-scale=1,user-scalable=no" />
    <title>Display HTML Overlay with Zoom</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <style>
        #map {
            position: absolute;
            top: 0;
            right: 0;
            bottom: 0;
            left: 0;
        }

        .leaflet-div-overlay {
            background: white;
            border: 1px solid black;
            padding: 10px;
            pointer-events: auto;
            cursor: move;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.5);
            transform-origin: top left;
        }

        .pointDrawCenter {
            background-color: rgba(0, 128, 0, 0.267);
            border: 2px solid rgba(0, 0, 0, 0.267);
            border-radius: 50%;
            width: 15px;
            height: 15px;
            z-index: 1000 !important;
        }

        .centered-overlay {
            transform-origin: center;
        }

        .resize-handle {
            width: 10px;
            height: 10px;
            background: red;
            position: absolute;
            cursor: nwse-resize;
            z-index: 10;
        }
    </style>
</head>

<body>
    <div id="map"></div>
    <div id="html-overlay" style="display: none;">
        <h2>Thông tin</h2>
        <p>Đây là nội dung bạn muốn hiển thị.</p>
    </div>
    <p><a href="https://www.maptiler.com/copyright/" target="_blank" rel="noopener">&copy; MapTiler</a> <a
            href="https://www.openstreetmap.org/copyright" target="_blank" rel="noopener">&copy; OpenStreetMap
            contributors</a></p>

    <script>
        const map = L.map('map').setView([49.2125578, 16.62662018], 14);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            maxZoom: 19,
            attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
        }).addTo(map);

        const latLng = L.latLng(49.2125578, 16.62662018);
        let pointDrawCenter = L.marker(latLng, {
            icon: L.divIcon({
                className: 'pointDrawCenter',
                iconSize: [15, 15],
                iconAnchor: [-7.5, -7.5]
            })
        }).addTo(map);

        L.DivOverlay = L.Layer.extend({
            initialize: function (htmlElement, latLng, options) {
                this._htmlElement = htmlElement;
                this._latLng = latLng;
                L.setOptions(this, options);
                this._dragging = false;
                this._resize = false; // Added this line
            },

            onAdd: function (map) {
                this._map = map;
                if (!this._container) {
                    this._initLayout();
                }
                map.getPanes().overlayPane.appendChild(this._container);
                this._update();
                map.on('zoomend', this._update, this);

                // Use document-wide event listeners to handle dragging
                this._container.addEventListener('mousedown', this._startDrag.bind(this));
            },

            onRemove: function (map) {
                if (this._container) {
                    map.getPanes().overlayPane.removeChild(this._container);
                }
                map.off('zoomend', this._update, this);
            },

            _initLayout: function () {
                this._container = this._htmlElement;
                L.DomUtil.addClass(this._container, 'leaflet-div-overlay');
                L.DomUtil.addClass(this._container, 'centered-overlay');
                this._container.style.position = 'absolute';

                // Create resize handles
                this._createResizeHandles();
            },

            _createResizeHandles: function () {
                if (this.options.editing) {
                    const positions = ['top-left', 'top-right', 'bottom-left', 'bottom-right',
                    'top-middle', 'bottom-middle', 'left-middle', 'right-middle'];
                positions.forEach((position) => {
                    const handle = document.createElement('div');
                    handle.className = 'resize-handle';
                    handle.style.backgroundColor = position.includes('middle') ? 'blue' : 'red';

                    if (position.includes('top')) handle.style.top = '-5px';
                    if (position.includes('bottom')) handle.style.bottom = '-5px';
                    if (position.includes('left')) handle.style.left = '-5px';
                    if (position.includes('right')) handle.style.right = '-5px';

                    if (position === 'top-middle') {
                        handle.style.left = '50%';
                        handle.style.transform = 'translateX(-50%)';
                    } else if (position === 'bottom-middle') {
                        handle.style.left = '50%';
                        handle.style.transform = 'translateX(-50%)';
                    } else if (position === 'left-middle') {
                        handle.style.top = '50%';
                        handle.style.transform = 'translateY(-50%)';
                    } else if (position === 'right-middle') {
                        handle.style.top = '50%';
                        handle.style.transform = 'translateY(-50%)';
                    }

                    handle.addEventListener('mousedown', (e) => this._startResize(e, position));
                    this._container.appendChild(handle);
                });
                }
            },

            _update: function () {
                if (!this._map) return;
                const zoom = this._map.getZoom();
                const scale = Math.pow(2, zoom - this.options.initZoom);
                const position = this._map.latLngToLayerPoint(this._latLng);

                const width = this.options.initialWidthMap * scale;
                const height = this.options.initialHeightMap * scale;

                this._container.style.width = width + 'px';
                this._container.style.height = height + 'px';
                L.DomUtil.setPosition(this._container, position.subtract([width / 2, height / 2]));
                this._container.style.display = 'block';
                pointDrawCenter.setLatLng(this._latLng);
            },

            _startDrag: function (e) {
                if (this.options.dragging) {
                    this._map.dragging.disable();
                    this._dragging = true;
                    this._startPoint = this._map.latLngToLayerPoint(this._latLng);
                    this._startMousePoint = L.point(e.clientX, e.clientY);
                    document.addEventListener('mousemove', this._drag.bind(this));
                    document.addEventListener('mouseup', this._endDrag.bind(this));
                    e.preventDefault();
                }
            },

            _drag: function (e) {
                if (!this._dragging) return;
                const currentMousePoint = L.point(e.clientX, e.clientY);
                const offset = currentMousePoint.subtract(this._startMousePoint);
                const newPoint = this._startPoint.add(offset);
                this._latLng = this._map.layerPointToLatLng(newPoint);
                this._update();
            },

            _endDrag: function () {
                this._dragging = false;
                this._map.dragging.enable();
                document.removeEventListener('mousemove', this._drag.bind(this));
                document.removeEventListener('mouseup', this._endDrag.bind(this));
            },

            _startResize: function (e, position) {
                this._resize = true;
                this._initialMousePoint = L.point(e.clientX, e.clientY);
                this._initialWidth = this.options.initialWidthMap;
                this._initialHeight = this.options.initialHeightMap;

                document.addEventListener('mousemove', (e) => this._resizeOverlay(e, position));
                document.addEventListener('mouseup', this._endResize.bind(this));
                e.preventDefault();
            },

            _resizeOverlay: function (e, position) {
                if (!this._resize) return;

                const currentMousePoint = L.point(e.clientX, e.clientY);
                const widthDiff = currentMousePoint.x - this._initialMousePoint.x;
                const heightDiff = currentMousePoint.y - this._initialMousePoint.y;

                if (position.includes('right')) {
                    this.options.initialWidthMap = Math.max(50, this._initialWidth + widthDiff);
                } else if (position.includes('left')) {
                    this.options.initialWidthMap = Math.max(50, this._initialWidth - widthDiff);
                }

                if (position.includes('bottom')) {
                    this.options.initialHeightMap = Math.max(50, this._initialHeight + heightDiff);
                } else if (position.includes('top')) {
                    this.options.initialHeightMap = Math.max(50, this._initialHeight - heightDiff);
                }

                this._update();
            },

            _endResize: function () {
                this._resize = false;
                document.removeEventListener('mousemove', this._resizeOverlay.bind(this));
                document.removeEventListener('mouseup', this._endResize.bind(this));
            }
        });

        const legendDiv = document.createElement('div');
        legendDiv.innerHTML = `
            <h3>Legend</h3>
            <div>Wall Light</div>
            <div>Downlight</div>
            <div>Pendant Light</div>
            <div>Double Powerpoint</div>
            <div>USP Powerpoint</div>
        `;

        const htmlOverlay = new L.DivOverlay(legendDiv, latLng, {
            initialWidthMap: 200,
            initialHeightMap: 100,
            dragging: true,
            isUpdateLocation: true,
            initZoom: 14,
            editing: true,
        });

        htmlOverlay.addTo(map);
    </script>
</body>

</html>